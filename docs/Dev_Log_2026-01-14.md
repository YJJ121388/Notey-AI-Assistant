# 开发日志 - 2026年1月14日

## 今日开发概览

今天主要完成了 Notey App 的多项 UI/UX 优化和功能完善，涉及输入框交互、笔记分类系统、详情页面等模块。

---

## 一、输入框优化经验

### 1. 多行输入框的实现

**问题**：单行 TextField 无法满足长文本输入需求，且文字超出时会导致布局变形。

**解决方案**：
- 使用 `TextField` 的 `axis: .vertical` 参数支持多行
- 配合 `.lineLimit(2)` 限制最大行数
- 使用 `GeometryReader` 获取容器宽度，确保布局稳定

```swift
TextField("输入文件夹名称", text: $folderName, axis: .vertical)
    .lineLimit(2)
```

### 2. 拼音输入的字数限制处理

**问题**：使用 SwiftUI 原生 TextField 时，拼音输入过程中的未确认文字会被计入字数，导致输入被意外截断。

**解决方案**：使用 `UIViewRepresentable` 包装 `UITextView`，通过检测 `markedTextRange` 判断是否处于拼音输入状态：

```swift
func textViewDidChange(_ textView: UITextView) {
    let currentText = textView.text ?? ""
    
    // 检查是否有未确认的拼音输入
    if let markedTextRange = textView.markedTextRange,
       let _ = textView.text(in: markedTextRange) {
        // 正在输入拼音，不进行截断
        text = currentText
    } else {
        // 拼音已确认，进行长度限制
        if currentText.count > maxLength {
            let limitedText = String(currentText.prefix(maxLength))
            textView.text = limitedText
            text = limitedText
        } else {
            text = currentText
        }
    }
}
```

**经验总结**：处理中文输入时，务必考虑拼音输入法的特殊性。

### 3. 字数统计的布局

**最佳实践**：将字数统计固定在输入框右下角
- 使用 `VStack` + `Spacer()` 将统计推到底部
- 使用 `HStack` + `Spacer()` 将统计推到右侧

---

## 二、Sheet 弹窗开发经验

### 1. 动态高度计算

根据内容数量动态计算 Sheet 高度，避免过多空白或内容被截断：

```swift
private func calculateSheetHeight() -> CGFloat {
    let dragIndicatorHeight: CGFloat = 28
    let itemHeight: CGFloat = 60
    let spacing: CGFloat = 12
    let maxVisibleItems: Int = 4
    
    let visibleItemCount = min(categories.count, maxVisibleItems)
    let itemsHeight = CGFloat(visibleItemCount) * itemHeight + CGFloat(max(0, visibleItemCount - 1)) * spacing
    
    return dragIndicatorHeight + itemsHeight + bottomPadding
}
```

### 2. Sheet 中嵌套 Sheet

**场景**：CategorySheetView 中点击"新建文件夹"需要弹出 AddFolderSheetView。

**实现**：使用 `@State` 控制内部 Sheet 的显示：

```swift
@State private var showAddFolderSheet = false

.sheet(isPresented: $showAddFolderSheet) {
    AddFolderSheetView(onAddFolder: { name in
        // 处理新建文件夹
    })
}
```

### 3. 避免 Sheet 崩溃

**教训**：复杂的 `UIViewRepresentable` 组件在 Sheet 中可能导致崩溃。

**解决**：优先使用 SwiftUI 原生组件，必要时才使用 UIKit 桥接。

---

## 三、数据流管理经验

### 1. Binding vs 回调

**场景**：子视图需要修改父视图的数据。

**推荐方案**：回调函数 + 父视图直接修改 @State

```swift
// 父视图
@State private var personalLibrary: [Folder] = []

// 传递回调给子视图
LibraryView(
    personalLibrary: $personalLibrary,
    onMoveNoteToFolder: moveNoteToFolder
)

// 父视图中的处理函数
func moveNoteToFolder(noteId: String, folderId: String) {
    // 直接修改 @State，SwiftUI 会自动更新 UI
}
```

### 2. 本地状态 vs 外部状态

**CategorySheetView 的设计**：
- 使用 `@State private var localCategories` 管理本地显示
- 通过 `onAddFolder` 回调通知外部同步数据

这样新建的文件夹可以立即显示在列表中，同时外部数据也会更新。

---

## 四、剪贴板功能

### iOS 剪贴板 API

```swift
// 复制文本到剪贴板
UIPasteboard.general.string = "要复制的文本"

// 配合 Toast 提示用户
showCopiedToast = true
DispatchQueue.main.asyncAfter(deadline: .now() + 2) {
    showCopiedToast = false
}
```

---

## 五、Toast 提示的使用场景

### 操作反馈提示

在关键操作完成后给用户即时反馈，提升用户体验：

```swift
// 分类归档成功提示
toastManager.show("分类归档成功，已归档至「\(folderTitle)」")

// 删除成功提示
toastManager.show("笔记「\(noteTitle)」已删除")

// 复制成功提示
showCopiedToast = true
```

**最佳实践**：
- 提示内容要具体，包含操作对象（如文件夹名称、笔记名称）
- 使用书名号「」包裹名称，更清晰
- Toast 显示 2 秒后自动消失
- 位置固定在顶部，不遮挡主要内容

---

## 六、测试相关

### Simulator vs Preview

| 功能 | Preview | Simulator | 真机 |
|------|---------|-----------|------|
| 键盘弹出 | ❌ | ✅ (Cmd+K) | ✅ |
| 拼音输入 | ❌ | ✅ | ✅ |
| 剪贴板 | ❌ | ✅ | ✅ |
| 手势交互 | 部分 | ✅ | ✅ |

**建议**：UI 布局用 Preview 快速迭代，交互功能必须在 Simulator 或真机测试。

---

## 七、今日完成的功能清单

1. ✅ AddFolderSheetView 输入框优化（多行、字数限制、拼音处理）
2. ✅ NoteDetailView 编辑页面标题输入框优化
3. ✅ FolderRow 展开时显示完整文件夹名称
4. ✅ 未分类笔记隐藏收藏按钮
5. ✅ 未分类笔记专用删除弹窗（DeleteOnlySheetView）
6. ✅ HomeView 未分类笔记分类功能
7. ✅ CategorySheetView 新建文件夹功能
8. ✅ DraftDetailView 复制链接功能优化
9. ✅ VideoTooLongDetailView 新页面（视频过长场景）
10. ✅ 分类归档成功 Toast 提示（显示归档的文件夹名称）
11. ✅ 未分类笔记时间戳显示（今天/昨天/X天前/日期）
12. ✅ 默认文件夹功能（始终在第一位，只有收藏星标）

---

## 八、明日计划

- [ ] 本地数据持久化（SwiftData）
- [ ] 草稿箱数据模型完善（区分失败类型）
- [ ] 笔记搜索功能

---

## 九、踩坑记录

1. **presentationDetents 动态高度**：使用计算属性而非状态变量，避免频繁重新计算
2. **UIViewRepresentable 内存管理**：注意 NotificationCenter 的移除
3. **Sheet 背景**：使用 `.presentationBackground` 而非 `.background` 避免白边

---

## 十、默认文件夹功能实现

### 需求
在"我的笔记"子库中添加一个默认文件夹，始终显示在第一位，只提供收藏星标交互，不提供更多选项。

### 实现方案

**1. 创建专用组件 DefaultFolderRow**

与 FolderRow 类似，但移除了"更多选项"按钮：

```swift
struct DefaultFolderRow: View {
    let folder: Folder
    let isExpanded: Bool
    let isFavorited: Bool
    let onTap: () -> Void
    let onFavorite: () -> Void
    
    var body: some View {
        Button(action: onTap) {
            GlassCard {
                HStack(alignment: .top, spacing: 12) {
                    // 展开/收起箭头
                    Image(systemName: isExpanded ? "chevron.down" : "chevron.right")
                    // 图标和标题
                    Text(folder.icon)
                    Text(folder.title)
                    Spacer()
                    // 只有收藏星标，没有更多选项
                    Button(action: onFavorite) {
                        Image(systemName: isFavorited ? "star.fill" : "star")
                    }
                }
            }
        }
    }
}
```

**2. 状态管理**

在 ContentView 中添加独立的 `defaultFolder` 状态：

```swift
@State private var defaultFolder: Folder = Folder(
    id: "default-folder", 
    title: "默认文件夹", 
    icon: "📁", 
    children: []
)
```

**3. 数据流设计**

- `defaultFolder` 作为 `@Binding` 传递给 LibraryView 和 HomeView
- CategorySheetView 的分类列表中，默认文件夹始终在最前面
- `moveNoteToFolder` 函数需要特殊处理默认文件夹的 ID

```swift
// 分类列表构建
categories: [CategoryItem(id: defaultFolder.id, title: defaultFolder.title, icon: defaultFolder.icon)] 
    + personalLibrary.map { CategoryItem(id: $0.id, title: $0.title, icon: $0.icon) }
```

**4. 为什么不放在 personalLibrary 数组中？**

- 默认文件夹不可删除、不可重命名
- 需要始终保持在第一位
- 独立管理更清晰，避免误操作

### 涉及文件

- `Notey/Components/DefaultFolderRow.swift` - 新建
- `Notey/Views/Main/LibraryView.swift` - 添加默认文件夹显示
- `Notey/Views/Main/HomeView.swift` - 分类时包含默认文件夹
- `Notey/ContentView.swift` - 状态管理和数据操作

---

## 十一、UX 设计理念：多入口与功能冗余

### 案例：未分类笔记的双入口设计

在 Notey 中，未分类笔记的归档功能同时出现在两个位置：
- **HomeView**：最近记录的未分类笔记卡片
- **LibraryView**：未分类笔记完整列表

这不是重复设计，而是基于以下 UX 理念的有意为之。

### 1. 多入口设计（Multiple Entry Points）

同一功能提供多个触发入口，让用户在不同场景下都能完成任务：

| 入口 | 目标用户 | 使用场景 |
|------|----------|----------|
| HomeView | 浏览型用户 | 刚打开 App，快速处理新内容 |
| LibraryView | 整理型用户 | 专门来管理笔记，批量归档 |

### 2. 用户心智模型匹配

用户在不同页面有不同的心理预期：
- **首页心智**：看最新动态、快速操作、效率优先
- **笔记库心智**：查看完整结构、系统管理、全面掌控

两个入口分别匹配两种心智模式，降低认知负担。

### 3. 渐进式披露（Progressive Disclosure）

```
HomeView: 展示最近 N 条未分类笔记（有限）
    ↓ 用户想看更多
LibraryView: 展示全部未分类笔记（完整）
```

信息量逐层递进，首页保持简洁，详情页提供完整视图。

### 4. 容错性设计（Error Tolerance）

用户可能：
- 在 HomeView 滑过未分类卡片没注意
- 忘记自己有待归档的内容
- 想稍后再处理

LibraryView 作为"兜底入口"，确保用户不会遗漏待处理内容。

### 5. 尼尔森可用性原则的体现

- **系统状态可见性**：未分类笔记这一"待处理状态"在多处可见
- **用户控制与自由**：用户可选择在哪里、什么时候处理
- **灵活性与效率**：新手可在首页快速操作，专家可在笔记库批量管理
- **一致性**：两处的分类操作流程完全相同（都弹出 CategorySheet）

### 设计启示

> 重要功能不要只有一个入口。多入口不是冗余，而是对不同用户场景的尊重。

**适用场景**：
- 核心功能（如本例的归档）
- 高频操作
- 容易被忽略但重要的状态提示

**不适用场景**：
- 低频设置项
- 破坏性操作（如删除，应该收敛入口）

---

*记录人：独立开发者*
*项目：Notey - AI 笔记助手*
