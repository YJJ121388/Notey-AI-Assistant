# 📝 Notey PRD/迭代文档 

| 版本 | 日期 | 修改人 | 备注 |
| :--- | :--- | :--- | :--- |
| **v3.0** | **2026-01-14** | **YJJ121388** | **AI 助手**：引入联网搜索 + LLM 的笔记拓展能力 |
| v2.0 | 2026-01-10 | YJJ121388 | **架构重构**：独立 App 化，引入自定义 API、读写分离编辑与本地数据主权 |
| v1.3 | 2026-01-01 | YJJ121388 | 新增失败重试机制与状态流转 |
| v1.0 | 2026-12-08 | YJJ121388 | MVP 初始版本定义 |

## 1. 项目背景 & 迭代目标 (Background & Goals)
随着用户对笔记质量要求的提高，单纯的“自动化生成”已无法满足深度学习需求。Notey v2.0 旨在从“自动化脚本”升级为**“本地优先的 AI 笔记容器”**。

**本次迭代核心解决三大痛点：**
1.  **交互闭环缺失**：补全笔记生成后的“查看-管理-修订”全链路体验。
2.  **服务稳定性**：通过完善的 Draft（草稿）机制解决 AI/网络失败导致的笔记丢失问题。
3.  **服务可持续性**：引入**服务额度 (Quota) 机制**，实现“零配置开箱即用”的极简体验，同时通过本地风控策略有效控制 API 成本，保障服务的长期稳定运行。

---

## 2. 核心交互链路 (Core User Flows) 🌟

### 2.1 ⚡️ 智能捕获与草稿链路 (Capture & Draft Flow)
> **升级点**：明确了“成功归档”与“失败存草稿”的分流逻辑。

1.  **触发**：用户在外部 App 点击分享 -> 选择 Notey -> 后台静默创建任务。
2.  **处理**：应用尝试调用配置好的 API 进行解析。
3.  **分支 A (成功)**：
    * AI 返回结构化 Markdown。
    * 自动存入“未分类”文件夹。
    * 状态标记为 `Archived`。
4.  **分支 B (失败/超时)**：
    * **兜底策略**：立即保存原始 URL、标题（如有）及抓取时间 -> 存入 **“草稿箱 (Recent Tabs)”** -> 状态标记为 `Draft`。
    * **用户感知**：App 内首页顶部出现标红的草稿卡片，提示“需重试”。


### 2.2 🗂 端内读写与管理链路 (In-App Management & Editing Flow)
> **升级点**：从 v1.0 的“快捷指令生成 -> 跳转系统备忘录查看/修改”的割裂体验，升级为 **App 端内一站式闭环**。
>
> **核心价值**：重点不仅在于“能编辑”，更在于提供了 v1.0 缺失的 **结构化管理能力**（收藏、分类归档），让笔记从“杂乱堆积”变为“有序资产”。

1.  **查看 (View Mode)**：
    * **体验升级**：不再跳转系统备忘录，直接在 App 内以精美的 Markdown 样式渲染查看。
2.  **管理 (Management) [核心升级]**：
    * **分类归档**：在阅读过程中，可直接点击底部菜单，将笔记从“未分类 (Uncategorized)”移动至自定义文件夹（如“Python学习”、“面试资料”）。
    * **状态标记**：支持将高价值笔记标记为“收藏 (Favorite)”，方便后续快速索引。
3.  **修订 (Edit Mode)**：
    * **端内闭环**：点击 `Edit` 直接进入源码模式修正 AI 内容或追加想法，修改后的内容实时同步至 App 本地数据库，无需在两个 App 间反复横跳。


### 2.3 🔋 服务额度与风控链路 (Service Quota & Rate Limiting)
> **策略设置**：“官方托管 + 每日限额”策略。
> **核心价值**：降低用户使用门槛（开箱即用），同时通过本地风控策略保护开发者服务成本（避免阿里云资费失控）。

1.  **交互展示 (UI)**：
    * **入口**：设置页 -> **额度说明 (Service Quota)**。
    * **可视化**：展示“今日剩余次数”的进度条或数字仪表盘（例如：`今日已用: 2/5`）。
    * **耗尽反馈**：当用户达到每日上限时，触发 Capture 链路时不再请求 API，而是弹窗提示：“今日 AI 额度已用完，请明天再来探索。”

2.  **逻辑策略 (Logic)**：
    * **计数方式**：基于本地 `UserDefaults` 或 `AppStorage` 进行计数。
    * **重置机制**：每日凌晨 00:00 自动重置计数器。
    * **默认限额**：v2.0 阶段设定为 **5 次/日** (可根据后续运营成本动态通过云端 Config 调整)。

3.  **成本控制 (Cost Control)**：
    * 所有 API 请求统一使用 App 内置的官方 Coze Token 和阿里云 Key。
    * 通过前端限制请求发起次数，物理阻断超额费用的产生。


---

## 3. 功能需求清单 (Feature List)

### P0 (MVP 核心重构 - Must Have)
> **验收标准**：必须实现“捕获-查看-管理-编辑”的完整闭环，且允许用户配置 API。

#### 1. 基础架构与数据主权
- [ ] **独立客户端架构**：基于 SwiftUI 重构，不再依赖 iOS Shortcuts UI，确保交互的连贯性。
- [ ] **本地数据库 (SwiftData)**：
    - [ ] 设计支持 **“草稿 (Draft)”** 与 **“归档 (Archived)”** 双状态的数据模型。
    - [ ] 实现 **“未分类 (Uncategorized)”** 作为默认入库位置的逻辑。

#### 2. 智能捕获与容错机制 (对应链路 2.1)
- [ ] **静默捕获**：Share Extension 触发后，后台自动执行 API 请求。
- [ ] **状态分流逻辑**：
    - [ ] **成功**：解析 Markdown -> 存入“未分类” -> 标记为 `未分类笔记`。
    - [ ] **失败**：保留 URL/标题 -> 存入“草稿箱” -> 标记为 `未录入笔记`。
- [ ] **草稿箱入口**：在首页显著位置展示失败任务，点击后提供 **“重试 (Retry)”** 按钮。

#### 3. 端内管理与闭环 (对应链路 2.2)
- [ ] **Markdown 渲染器 (View Mode)**：在 App 内直接渲染美观的笔记详情（不再跳转系统备忘录）。
- [ ] **笔记归档 (Move to Folder)**：**[核心]** 提供菜单或 Sheet，允许用户将笔记从“未分类”移动至“指定文件夹”。
- [ ] **源码编辑器 (Edit Mode)**：支持在 App 端内修改 Markdown 源码，并实时保存回本地数据库。

#### 4. 服务风控系统 (对应链路2.3)
- [ ] **本地配额管理**：
    - [ ] 基于 `UserDefaults/AppStorage` 实现本地计数器。
    - [ ] 实现每日 `00:00` 自动重置逻辑。
- [ ] **额度仪表盘 UI**：
    - [ ] 新增 **Dashboard 卡片**，通过图形化组件（如 `Circle` 或 `ProgressView`）展示剩余次数。
- [ ] **请求阻断机制**：
    - [ ] 在网络层封装 Check 逻辑，额度耗尽时直接拦截请求并返回特定错误码供 UI 弹窗使用。

---

### P1 (体验优化 - Should Have)
> **验收标准**：提升管理的效率和视觉体验，为多模态打基础。

#### 1. 高级管理能力
- [ ] **文件夹自定义**：支持用户创建、重命名、删除二级文件夹 (Category)。
- [ ] **收藏夹 (Favorites)**：在笔记详情页增加“⭐️”按钮，支持通过“我的收藏”快速筛选高价值内容。

#### 2. 视觉与交互增强
- [ ] **Deep Ocean 视觉适配**：全量应用深色毛玻璃 UI 规范。
- [ ] **导出功能**：支持将 Markdown 笔记导出为 `.md` 文件或复制纯文本。


---

## 4. UI/UX 规范 (Design Specs)

### 4.1 视觉风格 (Visual Identity)
* **主题**：**Deep Ocean Glassmorphism** (深海毛玻璃)。
* **背景**：`#87CEEB` (天蓝) 到 `#000000` (纯黑) 的线性渐变，叠加动态光斑。
* **卡片**：高模糊度 (`Blur 40px`) + 低透明度白底 (`White 10%`) + 内发光描边。

### 4.2 状态反馈 (Feedback)
* **Draft (草稿态)**：
    * 卡片显示：展示视频原始链接 + 红色/黄色状态指示灯。
    * 操作反馈：点击重试时显示 Loading Spinner。
* **Archived (归档态)**：
    * 卡片显示：展示 AI 生成的摘要 (`Summary`)
* **Toast 提示**：
    * 所有保存、删除、配置成功操作，需在顶部弹出黑色胶囊状 Toast 提示（如 "已保存"、“已删除”等）。

### 4.3 交互手势
* **列表页**：支持点击卡片进入详情。
* **键盘交互**：编辑模式下，键盘弹起时需自动推高内容区域，防止遮挡输入焦点。

---

# 🤖 Notey V3.0 - AI 助手与笔记拓展

## 5. V3.0 项目背景 & 迭代目标

### 5.1 用户洞察
通过用户访谈发现核心需求：
> "记录了厦门旅游攻略后，想知道还有什么景点值得去，但需要切出 App 去搜索，再手动整理回笔记，很麻烦。"

### 5.2 产品定位升级
从 **"AI 笔记容器"** 升级为 **"AI 笔记 + 知识拓展助手"**

| V2.0 | V3.0 |
|------|------|
| 记录 → 管理 → 结束 | 记录 → 管理 → **AI 拓展** → 丰富笔记 |
| 被动存储 | 主动增值 |

### 5.3 核心价值
1. **减少上下文切换**：用户无需离开 App 去搜索，AI 助手直接提供拓展信息
2. **保持笔记格式一致**：AI 输出自动匹配用户笔记的结构和风格
3. **用户掌控内容**：选择性添加，而非全量覆盖

---

## 6. V3.0 核心交互链路 🌟

### 6.1 🤖 AI 助手拓展链路 (AI Assistant Expansion Flow)

```
┌─────────────────────────────────────────────────────────────┐
│                      笔记详情页                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  厦门旅游攻略                                        │   │
│  │  ─────────────────                                  │   │
│  │  🏝️ 鼓浪屿 - 世界文化遗产，必去打卡                  │   │
│  │  🏘️ 曾厝垵 - 文艺小渔村，美食聚集地                  │   │
│  │  ...                                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                              ┌───┐         │
│                                              │🤖│ ← 浮窗按钮│
│                                              └───┘         │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 点击
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    AI 助手弹窗                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  🔍 正在为你搜索更多厦门景点推荐...                    │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 搜索 + LLM 处理
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    AI 推荐结果                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  AI 为你找到以下推荐：                                │   │
│  │                                                      │   │
│  │  ☑️ 🌊 沙坡尾                                        │   │
│  │     厦门最文艺的老街区，咖啡馆和涂鸦墙的天堂          │   │
│  │                                                      │   │
│  │  ☐ 🚴 环岛路                                         │   │
│  │     骑行看海的最佳路线，全长约 31 公里                │   │
│  │                                                      │   │
│  │  ☑️ 🛍️ 中山路                                        │   │
│  │     百年老街，闽南骑楼建筑 + 各种小吃                 │   │
│  │                                                      │   │
│  │  ☐ 🌅 白城沙滩                                       │   │
│  │     厦大旁的免费沙滩，看日落绝佳位置                  │   │
│  │                                                      │   │
│  │              [ 添加选中内容到笔记 ]                   │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 用户选择 + 点击添加
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      笔记详情页（更新后）                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  厦门旅游攻略                                        │   │
│  │  ─────────────────                                  │   │
│  │  🏝️ 鼓浪屿 - 世界文化遗产，必去打卡                  │   │
│  │  🏘️ 曾厝垵 - 文艺小渔村，美食聚集地                  │   │
│  │  ...                                                │   │
│  │  ─────────────────                                  │   │
│  │  📌 AI 推荐补充                                      │   │
│  │  🌊 沙坡尾 - 厦门最文艺的老街区...                   │   │
│  │  🛍️ 中山路 - 百年老街，闽南骑楼建筑...              │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 技术处理流程

```
用户点击 AI 助手按钮
        │
        ▼
┌───────────────────┐
│  Step 1: 主题提取  │
│  LLM 分析笔记内容  │
│  提取：主题、格式  │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  Step 2: 联网搜索  │
│  调用搜索 API      │
│  获取相关内容      │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  Step 3: 内容整理  │
│  LLM 筛选 + 格式化 │
│  匹配笔记风格      │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  Step 4: 结构化输出│
│  返回 JSON 数组    │
│  供 App 渲染选择   │
└───────────────────┘
```

---

## 7. V3.0 技术架构

### 7.1 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                       Notey App (iOS)                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  NoteDetailView                                      │   │
│  │    └── AIAssistantButton (浮窗)                      │   │
│  │          └── AIAssistantSheet (弹窗)                 │   │
│  │                └── RecommendationList (选择列表)     │   │
│  └─────────────────────────────────────────────────────┘   │
└───────────────────────────┬─────────────────────────────────┘
                            │ HTTPS
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Notey Backend Service                    │
│                    (Node.js / Python)                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  /api/expand                                         │   │
│  │    ├── 接收：笔记内容                                 │   │
│  │    ├── 调用：搜索 API + LLM API                      │   │
│  │    └── 返回：结构化推荐列表                           │   │
│  └─────────────────────────────────────────────────────┘   │
└──────────┬────────────────────────────┬─────────────────────┘
           │                            │
           ▼                            ▼
┌─────────────────────┐      ┌─────────────────────┐
│    Search API       │      │      LLM API        │
│  (Serper / Bing)    │      │  (Claude / GPT)     │
│                     │      │                     │
│  - 实时搜索结果      │      │  - 主题提取          │
│  - 热门内容排序      │      │  - 内容筛选          │
│                     │      │  - 格式化输出        │
└─────────────────────┘      └─────────────────────┘
```

### 7.2 API 选型建议

| 用途 | 推荐服务 | 价格参考 | 备注 |
|------|----------|----------|------|
| 联网搜索 | Serper.dev | $50/5万次 | Google 搜索结果，支持中文 |
| 联网搜索 (备选) | Bing Search API | $3/1000次 | 微软官方，稳定性高 |
| LLM | Claude 3.5 Sonnet | ~$0.01/次 | 推理能力强，格式化输出稳定 |
| LLM (备选) | GPT-4o-mini | ~$0.005/次 | 成本更低，速度更快 |

### 7.3 数据模型

```swift
// AI 推荐项
struct AIRecommendation: Identifiable, Codable {
    let id: String
    let icon: String        // emoji 图标
    let title: String       // 推荐标题
    let detail: String      // 详细描述
    var isSelected: Bool    // 用户是否选中
}

// AI 拓展请求
struct ExpandRequest: Codable {
    let noteContent: String // 笔记原文
    let noteTitle: String   // 笔记标题
}

// AI 拓展响应
struct ExpandResponse: Codable {
    let topic: String                    // 识别的主题
    let recommendations: [AIRecommendation]  // 推荐列表
}
```

---

## 8. V3.0 功能需求清单

### P0 (MVP - Must Have)

#### 1. AI 助手入口
- [ ] **浮窗按钮**：笔记详情页右下角显示 AI 助手图标
- [ ] **点击触发**：点击后弹出 AI 助手 Sheet

#### 2. 后端服务
- [ ] **轻量后端部署**：Node.js 或 Python FastAPI
- [ ] **搜索 API 对接**：集成 Serper 或 Bing Search
- [ ] **LLM API 对接**：集成 Claude 或 GPT API
- [ ] **提示词工程**：
    - [ ] 主题提取 Prompt
    - [ ] 格式匹配 Prompt
    - [ ] 结构化输出 Prompt

#### 3. App 端交互
- [ ] **加载状态**：显示"正在为你搜索..."动画
- [ ] **推荐列表**：展示 AI 返回的推荐项（带勾选框）
- [ ] **选择性添加**：用户勾选后点击"添加到笔记"
- [ ] **笔记更新**：选中内容追加到笔记正文末尾

#### 4. 额度控制
- [ ] **AI 助手独立配额**：与笔记生成配额分开计算
- [ ] **默认限额**：3 次/日（可调整）

### P1 (体验优化 - Should Have)

#### 1. 交互增强
- [ ] **空状态处理**：搜索无结果时的友好提示
- [ ] **错误重试**：网络失败时提供重试按钮
- [ ] **历史记录**：保存最近一次 AI 推荐结果

#### 2. 智能优化
- [ ] **去重逻辑**：过滤掉笔记中已有的内容
- [ ] **相关度排序**：按与笔记主题的相关度排序推荐

---

## 9. V3.0 UI/UX 规范

### 9.1 AI 助手浮窗按钮
* **位置**：笔记详情页右下角，距离底部 100pt，距离右侧 20pt
* **尺寸**：56x56pt 圆形
* **样式**：毛玻璃背景 + 渐变边框 + 轻微阴影
* **图标**：🤖 或 SF Symbol `sparkles`

### 9.2 AI 助手弹窗
* **类型**：Bottom Sheet，高度约 60% 屏幕
* **背景**：延续 Deep Ocean 毛玻璃风格
* **内容区**：
    - 顶部：拖动指示条 + 标题"AI 助手"
    - 中部：推荐列表（可滚动）
    - 底部：操作按钮

### 9.3 推荐项卡片
* **布局**：左侧勾选框 + 中间内容（图标+标题+描述）
* **选中态**：边框高亮 + 背景加深
* **未选中态**：默认毛玻璃样式

### 9.4 状态反馈
* **加载中**：骨架屏 + "正在搜索..." 文案
* **成功**：展示推荐列表
* **无结果**：空状态插画 + "暂无更多推荐"
* **失败**：错误提示 + 重试按钮

---

## 10. V3.0 开发排期估算

| 模块 | 工作量 | 负责人 |
|------|--------|--------|
| 后端服务搭建 | 2-3 天 | - |
| 搜索 API 对接 | 1 天 | - |
| LLM API 对接 + 提示词 | 2 天 | - |
| App 端 UI（浮窗+弹窗+列表） | 3 天 | - |
| 笔记追加逻辑 | 1 天 | - |
| 联调测试 | 2 天 | - |
| **总计** | **约 2 周** | - |

---

## 11. V3.0 风险与应对

| 风险 | 影响 | 应对策略 |
|------|------|----------|
| 搜索结果质量不稳定 | 推荐内容不相关 | 多轮 Prompt 优化 + 人工审核样本 |
| LLM 输出格式不稳定 | App 解析失败 | 强制 JSON Schema + 重试机制 |
| API 成本超预期 | 服务不可持续 | 严格配额控制 + 监控告警 |
| 用户使用率低 | 功能价值未验证 | 先做 MVP 验证，再投入优化 |
