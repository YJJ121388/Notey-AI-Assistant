# Notey 后端服务需求文档

## 1. 项目概述

### 1.1 背景
Notey 是一个 iOS 智能笔记应用，目前已完成前端 SwiftUI 界面开发（v2.0）。需要构建后端服务来支持：
- 视频内容提取与 AI 总结（v2.0 核心功能）
- 用户额度管理与风控
- AI 笔记拓展助手（v3.0 功能）

### 1.2 技术背景
- **前端**：iOS SwiftUI + SwiftData（本地数据库）
- **现有架构**：iOS Shortcuts + Coze Workflow（v1.0）
- **第三方服务**：
  - Coze API（字节跳动扣子）- LLM 总结
  - 阿里云 ASR - 语音转文字
  - 视频平台 API（抖音/TikTok/B站）

### 1.3 目标
构建一个轻量级、可扩展的后端服务，支持：
1. 视频 URL 解析与内容提取
2. AI 内容总结与格式化
3. 用户额度管理（每日限额 + 重置机制）
4. AI 助手联网搜索与内容拓展

---

## 2. 核心用户故事

### 2.1 视频转笔记（V2.0 核心功能）

**用户故事 2.1.1：视频内容捕获**
- **作为** 用户
- **我想要** 在抖音/B站分享视频到 Notey
- **以便** 自动提取视频内容并生成笔记

**验收标准**：
- [ ] 支持从分享链接中提取视频 URL
- [ ] 支持主流平台（抖音、TikTok、B站、小红书）
- [ ] 能够解析平台特定的 URL 格式和重定向
- [ ] 提取失败时返回明确的错误信息

**用户故事 2.1.2：视频内容解析**
- **作为** 系统
- **我想要** 从视频 URL 中提取音频和元数据
- **以便** 为 AI 总结提供原始素材

**验收标准**：
- [ ] 能够获取视频的真实流媒体地址
- [ ] 提取视频标题、作者、时长等元数据
- [ ] 支持音频流提取（无需下载完整视频）
- [ ] 处理视频过长场景（超过 10 分钟）

**用户故事 2.1.3：AI 内容总结**
- **作为** 系统
- **我想要** 将视频音频转换为结构化 Markdown 笔记
- **以便** 用户获得可读性强的笔记内容

**验收标准**：
- [ ] 调用阿里云 ASR 进行语音转文字
- [ ] 调用 Coze/LLM API 进行内容总结
- [ ] 输出格式化的 Markdown（包含标题、要点、时间戳）
- [ ] 总结内容包含关键信息提取和结构化组织
- [ ] 处理 ASR 或 LLM 调用失败的情况

**用户故事 2.1.4：草稿容错机制**
- **作为** 用户
- **我想要** 在 AI 处理失败时保留原始链接
- **以便** 稍后重试而不丢失数据

**验收标准**：
- [ ] API 失败时返回特定错误码（区分网络错误、超时、配额耗尽等）
- [ ] 返回原始 URL 和基础元数据供客户端保存为草稿
- [ ] 支持草稿重试接口（使用相同参数重新处理）

---

### 2.2 用户额度管理（V2.0 风控功能）

**用户故事 2.2.1：额度验证**
- **作为** 系统
- **我想要** 在处理请求前验证用户额度
- **以便** 控制 API 成本并防止滥用

**验收标准**：
- [ ] 每个用户每日默认额度为 5 次
- [ ] 请求前检查用户剩余额度
- [ ] 额度耗尽时返回 429 状态码和友好提示
- [ ] 记录每次 API 调用的额度消耗

**用户故事 2.2.2：额度重置**
- **作为** 系统
- **我想要** 每日自动重置用户额度
- **以便** 用户可以持续使用服务

**验收标准**：
- [ ] 每日 00:00（用户本地时区）自动重置额度
- [ ] 支持通过 API 查询当前剩余额度
- [ ] 支持管理员手动调整用户额度（可选）

**用户故事 2.2.3：额度查询**
- **作为** 用户
- **我想要** 查看我的剩余额度
- **以便** 合理安排使用

**验收标准**：
- [ ] 提供 GET /api/quota 接口返回剩余次数
- [ ] 返回今日已用次数和总额度
- [ ] 返回下次重置时间

---

### 2.3 AI 助手内容拓展（V3.0 功能）

**用户故事 2.3.1：笔记主题提取**
- **作为** 系统
- **我想要** 分析用户笔记内容并提取核心主题
- **以便** 为联网搜索提供精准关键词

**验收标准**：
- [ ] 接收笔记 Markdown 内容作为输入
- [ ] 使用 LLM 提取 3-5 个核心关键词
- [ ] 识别笔记的主题类型（旅游、技术、美食等）
- [ ] 返回结构化的主题分析结果

**用户故事 2.3.2：联网搜索与内容筛选**
- **作为** 系统
- **我想要** 根据笔记主题搜索高质量补充内容
- **以便** 为用户提供有价值的拓展信息

**验收标准**：
- [ ] 集成搜索 API（Serper/Bing/Google）
- [ ] 构建智能搜索查询（包含"高赞"、"必看"等限定词）
- [ ] 过滤低质量结果（基于热度、来源可信度）
- [ ] 返回 5-10 条结构化推荐内容

**用户故事 2.3.3：内容格式化与去重**
- **作为** 系统
- **我想要** 将搜索结果格式化为与原笔记风格一致的内容
- **以便** 用户可以无缝添加到笔记中

**验收标准**：
- [ ] 使用 LLM 将搜索结果转换为 Markdown 格式
- [ ] 匹配原笔记的结构风格（列表、段落、emoji 使用等）
- [ ] 检测并过滤与原笔记重复的内容
- [ ] 为每条推荐添加来源标注

**用户故事 2.3.4：AI 助手额度管理**
- **作为** 系统
- **我想要** 独立管理 AI 助手功能的额度
- **以便** 与笔记生成功能分开计费

**验收标准**：
- [ ] AI 助手默认额度为 3 次/日
- [ ] 与视频转笔记额度独立计算
- [ ] 提供独立的额度查询接口

---

## 3. 非功能性需求

### 3.1 性能要求
- **响应时间**：
  - 视频解析：< 5 秒
  - AI 总结：< 30 秒（取决于视频长度）
  - AI 助手搜索：< 10 秒
- **并发支持**：至少支持 100 并发请求
- **可用性**：99% 正常运行时间

### 3.2 安全要求
- 所有 API 端点需要身份验证（设备 ID 或 Token）
- API Key 和敏感配置使用环境变量管理
- 实施速率限制防止滥用
- 日志中不记录用户敏感信息

### 3.3 可扩展性
- 支持通过配置文件动态调整额度策略
- 支持添加新的视频平台解析器
- 支持切换不同的 LLM 提供商
- 模块化设计便于功能迭代

### 3.4 可维护性
- 完整的 API 文档（OpenAPI/Swagger）
- 结构化日志记录（请求 ID、用户 ID、操作类型）
- 错误追踪和监控（可选集成 Sentry）
- 单元测试覆盖率 > 70%

---

## 4. 技术约束

### 4.1 第三方服务依赖
- **Coze API**：用于 LLM 总结和内容处理
- **阿里云 ASR**：语音转文字服务
- **搜索 API**：Serper/Bing（V3.0）
- **视频平台 API**：需要处理各平台的反爬机制

### 4.2 部署环境
- 支持云服务器部署（阿里云/腾讯云）
- 支持 Serverless 部署（可选）
- 支持 Docker 容器化部署

### 4.3 数据存储
- 用户额度数据需要持久化存储
- 支持 Redis 缓存（可选，用于额度查询加速）
- 不存储用户笔记内容（本地优先原则）

---

## 5. API 端点概览

### V2.0 核心 API
- `POST /api/v2/process-video` - 视频转笔记
- `GET /api/v2/quota` - 查询额度
- `POST /api/v2/retry-draft` - 重试草稿

### V3.0 AI 助手 API
- `POST /api/v3/expand-note` - 笔记内容拓展
- `GET /api/v3/assistant-quota` - AI 助手额度查询

---

## 6. 优先级划分

### P0（必须实现）
- 视频 URL 解析与内容提取
- AI 内容总结（Coze + 阿里云 ASR）
- 基础额度管理（本地计数 + 验证）
- 错误处理与草稿容错

### P1（应该实现）
- 额度查询 API
- 草稿重试接口
- 结构化日志和监控
- API 文档

### P2（可以实现）
- AI 助手内容拓展（V3.0）
- Redis 缓存优化
- 管理后台（额度调整、用户管理）
- 性能监控和告警

---

## 7. 成功指标

- [ ] 视频转笔记成功率 > 90%
- [ ] API 平均响应时间 < 10 秒
- [ ] 额度管理准确率 100%
- [ ] 每日 API 成本可控（< 预算阈值）
- [ ] 用户反馈的错误率 < 5%

---

## 8. 风险与依赖

### 风险
1. **视频平台反爬**：平台可能更新 API 或加强反爬机制
2. **第三方服务稳定性**：Coze/阿里云服务可能出现故障
3. **成本控制**：LLM 和 ASR 调用成本可能超预期
4. **用户滥用**：恶意用户可能尝试绕过额度限制

### 依赖
- Coze API 稳定性和配额
- 阿里云 ASR 服务可用性
- 视频平台 URL 格式稳定性

---

## 9. 后续迭代方向

- 支持更多视频平台（YouTube、微博视频等）
- 多语言支持（英文视频转笔记）
- 用户自定义 API Key（高级用户）
- 笔记云同步功能（可选）
- AI 助手多模态支持（图片识别）
