# Notey 后端服务实施任务清单

## Phase 1: 基础架构搭建

### 1.1 项目初始化
- [ ] 1.1.1 创建 Node.js + TypeScript 项目
  - 初始化 package.json
  - 配置 TypeScript (tsconfig.json)
  - 安装核心依赖（Express/Fastify、dotenv、winston）
- [ ] 1.1.2 配置开发环境
  - 配置 ESLint 和 Prettier
  - 配置 nodemon 热重载
  - 配置 VS Code 调试配置
- [ ] 1.1.3 创建项目目录结构
  - 创建 src/ 目录及子目录
  - 创建 tests/ 目录
  - 创建 logs/ 目录

### 1.2 基础服务配置
- [ ] 1.2.1 配置管理模块
  - 创建 config/index.ts
  - 加载环境变量
  - 导出配置对象
- [ ] 1.2.2 Redis 连接
  - 安装 redis 客户端
  - 创建 utils/redis.ts
  - 实现连接池和错误处理
- [ ] 1.2.3 日志系统
  - 配置 winston logger
  - 创建 utils/logger.ts
  - 实现结构化日志格式

### 1.3 中间件开发
- [ ] 1.3.1 身份验证中间件
  - 创建 middleware/auth.ts
  - 实现设备 ID 验证
  - 添加请求 ID 生成
- [ ] 1.3.2 速率限制中间件
  - 创建 middleware/rateLimit.ts
  - 实现基于 IP 的限流
  - 配置限流规则
- [ ] 1.3.3 请求日志中间件
  - 创建 middleware/logger.ts
  - 记录请求开始和结束
  - 记录响应时间

### 1.4 错误处理
- [ ] 1.4.1 错误类型定义
  - 创建 utils/errors.ts
  - 定义错误码枚举
  - 创建自定义错误类
- [ ] 1.4.2 全局错误处理器
  - 实现错误处理中间件
  - 统一错误响应格式
  - 记录错误日志

### 1.5 健康检查
- [ ] 1.5.1 实现健康检查接口
  - 创建 /health 端点
  - 检查 Redis 连接状态
  - 返回服务状态信息

---

## Phase 2: V2.0 核心功能开发

### 2.1 额度管理服务
- [ ] 2.1.1 QuotaService 基础实现
  - 创建 services/quota.service.ts
  - 实现 checkQuota 方法
  - 实现 consumeQuota 方法
- [ ] 2.1.2 额度查询功能
  - 实现 getQuota 方法
  - 支持多种额度类型
  - 计算重置时间
- [ ] 2.1.3 额度重置机制
  - 实现定时任务（node-cron）
  - 每日 00:00 清理过期 key
  - 支持时区处理
- [ ] 2.1.4 单元测试
  - 测试额度检查逻辑
  - 测试额度消耗逻辑
  - 测试重置机制

### 2.2 视频解析器
- [ ] 2.2.1 抖音解析器
  - 创建 parsers/douyin.parser.ts
  - 实现 URL 正则匹配
  - 提取视频 ID 和元数据
  - 获取真实视频地址
- [ ] 2.2.2 B站解析器
  - 创建 parsers/bilibili.parser.ts
  - 支持 BV 号和 AV 号
  - 提取视频信息
  - 处理分 P 视频
- [ ] 2.2.3 小红书解析器（可选）
  - 创建 parsers/xiaohongshu.parser.ts
  - 实现 URL 解析
  - 提取视频信息
- [ ] 2.2.4 解析器工厂
  - 创建 parsers/index.ts
  - 根据 URL 自动选择解析器
  - 统一错误处理

### 2.3 第三方服务集成
- [ ] 2.3.1 Coze API 封装
  - 创建 services/coze.service.ts
  - 实现 API 调用方法
  - 处理响应和错误
  - 添加重试机制
- [ ] 2.3.2 阿里云 ASR 封装
  - 创建 services/asr.service.ts
  - 实现音频上传
  - 实现语音识别调用
  - 处理识别结果
- [ ] 2.3.3 错误处理和重试
  - 实现指数退避重试
  - 设置超时时间
  - 记录调用日志

### 2.4 视频处理服务
- [ ] 2.4.1 VideoService 基础实现
  - 创建 services/video.service.ts
  - 实现 processVideo 方法
  - 整合解析器和第三方服务
- [ ] 2.4.2 视频时长检查
  - 检查视频时长
  - 超过 10 分钟返回错误
  - 提供友好提示
- [ ] 2.4.3 音频提取
  - 实现音频流提取
  - 支持多种视频格式
  - 优化下载速度
- [ ] 2.4.4 内容总结
  - 调用 ASR 服务
  - 调用 Coze LLM
  - 格式化为 Markdown
- [ ] 2.4.5 错误处理
  - 处理各类错误场景
  - 返回结构化错误信息
  - 支持草稿保存

### 2.5 API 路由实现
- [ ] 2.5.1 POST /api/v2/process-video
  - 创建 routes/v2.routes.ts
  - 实现请求参数验证
  - 调用 VideoService
  - 返回处理结果
- [ ] 2.5.2 GET /api/v2/quota
  - 实现额度查询接口
  - 返回剩余额度信息
  - 计算重置时间
- [ ] 2.5.3 POST /api/v2/retry-draft
  - 实现草稿重试接口
  - 复用 process-video 逻辑
  - 添加重试标记

### 2.6 集成测试
- [ ] 2.6.1 API 端到端测试
  - 测试视频处理完整流程
  - 测试额度管理功能
  - 测试错误场景
- [ ] 2.6.2 Mock 第三方服务
  - Mock Coze API
  - Mock 阿里云 ASR
  - 测试各种响应场景

---

## Phase 3: 部署与运维

### 3.1 Docker 容器化
- [ ] 3.1.1 编写 Dockerfile
  - 使用 Node.js 18 Alpine 镜像
  - 配置构建步骤
  - 优化镜像大小
- [ ] 3.1.2 编写 docker-compose.yml
  - 配置 API 服务
  - 配置 Redis 服务
  - 配置网络和卷
- [ ] 3.1.3 本地测试
  - 构建 Docker 镜像
  - 启动容器
  - 验证功能正常

### 3.2 阿里云部署
- [ ] 3.2.1 购买和配置 ECS
  - 选择合适的实例规格
  - 配置安全组规则
  - 安装 Docker 和 Docker Compose
- [ ] 3.2.2 部署应用
  - 上传代码和配置
  - 配置环境变量
  - 启动服务
- [ ] 3.2.3 Nginx 反向代理
  - 安装 Nginx
  - 配置反向代理规则
  - 配置 HTTPS 证书
- [ ] 3.2.4 域名配置
  - 配置 DNS 解析
  - 申请 SSL 证书
  - 配置 HTTPS

### 3.3 监控和日志
- [ ] 3.3.1 日志收集
  - 配置日志文件轮转
  - 设置日志保留策略
  - 可选：集成日志分析工具
- [ ] 3.3.2 性能监控
  - 监控 API 响应时间
  - 监控错误率
  - 监控资源使用
- [ ] 3.3.3 告警配置
  - 配置告警规则
  - 设置通知渠道
  - 测试告警功能

### 3.4 iOS 客户端联调
- [ ] 3.4.1 API 文档交付
  - 编写 API 文档
  - 提供请求示例
  - 说明错误码
- [ ] 3.4.2 联调测试
  - 测试视频转笔记流程
  - 测试额度管理
  - 测试错误处理
- [ ] 3.4.3 性能优化
  - 优化响应时间
  - 减少不必要的请求
  - 优化错误提示

---

## Phase 4: V3.0 AI 助手功能

### 4.1 搜索服务集成
- [ ] 4.1.1 Serper API 封装
  - 创建 services/search.service.ts
  - 实现搜索方法
  - 处理搜索结果
- [ ] 4.1.2 搜索策略实现
  - 根据主题类型构建查询
  - 添加限定词和过滤器
  - 指定搜索来源

### 4.2 AI 助手服务
- [ ] 4.2.1 主题提取功能
  - 创建 services/ai.service.ts
  - 实现 extractTopics 方法
  - 调用 LLM 分析笔记
- [ ] 4.2.2 内容搜索
  - 实现 searchContent 方法
  - 调用搜索 API
  - 过滤低质量结果
- [ ] 4.2.3 结果格式化
  - 实现 formatResults 方法
  - 匹配原笔记风格
  - 生成推荐列表
- [ ] 4.2.4 内容去重
  - 检测重复内容
  - 过滤已有信息
  - 提高推荐质量

### 4.3 API 路由实现
- [ ] 4.3.1 POST /api/v3/expand-note
  - 创建 routes/v3.routes.ts
  - 实现请求参数验证
  - 调用 AIService
  - 返回推荐列表
- [ ] 4.3.2 GET /api/v3/assistant-quota
  - 实现 AI 助手额度查询
  - 独立于视频处理额度
  - 返回剩余次数

### 4.4 集成测试
- [ ] 4.4.1 AI 助手功能测试
  - 测试主题提取
  - 测试搜索功能
  - 测试结果格式化
- [ ] 4.4.2 端到端测试
  - 测试完整拓展流程
  - 测试各种笔记类型
  - 测试错误场景

---

## Phase 5: 优化与完善

### 5.1 性能优化
- [ ] 5.1.1 缓存优化
  - 实现视频元数据缓存
  - 实现搜索结果缓存
  - 优化 Redis 使用
- [ ] 5.1.2 并发优化
  - 优化异步处理
  - 限制并发请求数
  - 使用连接池

### 5.2 文档完善
- [ ] 5.2.1 API 文档
  - 使用 Swagger 生成文档
  - 添加交互式测试界面
  - 完善示例代码
- [ ] 5.2.2 部署文档
  - 编写部署指南
  - 添加故障排查说明
  - 提供配置示例
- [ ] 5.2.3 开发文档
  - 编写架构说明
  - 添加代码规范
  - 提供贡献指南

### 5.3 测试完善
- [ ] 5.3.1 单元测试补充
  - 提高测试覆盖率
  - 添加边界测试
  - 测试错误场景
- [ ] 5.3.2 压力测试
  - 测试并发性能
  - 测试长时间运行
  - 检测内存泄漏

---

## 优先级说明

- **P0（必须完成）**：Phase 1、Phase 2、Phase 3
- **P1（应该完成）**：Phase 4
- **P2（可以完成）**：Phase 5

## 预估时间

- Phase 1: 1 周
- Phase 2: 2-3 周
- Phase 3: 1 周
- Phase 4: 2 周
- Phase 5: 1 周

**总计**：约 7-8 周
